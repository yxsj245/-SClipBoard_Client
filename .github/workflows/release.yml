name: Build and Release CLI

on:
  push:
    tags:
      - 'v*'  # 当推送以 v 开头的标签时触发
  workflow_dispatch:  # 允许手动触发
    inputs:

      build_windows:
        description: '构建 Windows 版本'
        required: false
        default: true
        type: boolean
      build_macos:
        description: '构建 macOS 版本'
        required: false
        default: true
        type: boolean

# 添加必要的权限
permissions:
  contents: write    # 允许创建发布版本和上传文件
  actions: read      # 允许读取Actions状态
  checks: read       # 允许读取检查状态
  pull-requests: read # 允许读取PR信息
  issues: read       # 允许读取Issue信息

env:
  CACHE_VERSION: v1  # 增加此版本号来强制刷新所有缓存

jobs:


  # Windows 构建
  build_windows:
    if: ${{ (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')) || (github.event_name == 'workflow_dispatch' && inputs.build_windows) }}
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'

      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~\AppData\Local\pip\Cache
          key: ${{ env.CACHE_VERSION }}-${{ runner.os }}-pip-python3.13-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ env.CACHE_VERSION }}-${{ runner.os }}-pip-python3.13-
            ${{ env.CACHE_VERSION }}-${{ runner.os }}-pip-

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Cache PyInstaller build
        uses: actions/cache@v3
        with:
          path: |
            build\
            __pycache__\
            dist\
          key: ${{ env.CACHE_VERSION }}-${{ runner.os }}-pyinstaller-${{ hashFiles('**/*.py', '**/requirements.txt', 'main.py') }}
          restore-keys: |
            ${{ env.CACHE_VERSION }}-${{ runner.os }}-pyinstaller-

      - name: Build Windows executable using build script
        run: |
          python build.py

      - name: Prepare Windows distribution
        run: |
          mkdir windows-dist
          copy release\shared-clipboard-client.exe windows-dist\

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: shared-clipboard-client-windows-build
          path: windows-dist/

  # macOS 构建
  build_macos:
    if: ${{ (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')) || (github.event_name == 'workflow_dispatch' && inputs.build_macos) }}
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'

      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/Library/Caches/pip
          key: ${{ env.CACHE_VERSION }}-${{ runner.os }}-pip-python3.13-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ env.CACHE_VERSION }}-${{ runner.os }}-pip-python3.13-
            ${{ env.CACHE_VERSION }}-${{ runner.os }}-pip-

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Cache PyInstaller build
        uses: actions/cache@v3
        with:
          path: |
            build/
            __pycache__/
            dist/
          key: ${{ env.CACHE_VERSION }}-${{ runner.os }}-pyinstaller-${{ hashFiles('**/*.py', '**/requirements.txt', 'main.py') }}
          restore-keys: |
            ${{ env.CACHE_VERSION }}-${{ runner.os }}-pyinstaller-

      - name: Build macOS executable using build script
        run: |
          python build.py

      - name: Prepare macOS distribution
        run: |
          mkdir -p macos-dist
          cp release/shared-clipboard-client macos-dist/
          chmod +x macos-dist/shared-clipboard-client

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: shared-clipboard-client-macos-build
          path: macos-dist/

  # 创建发布版本（仅在推送标签时触发）
  create_release:
    if: ${{ github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v') }}
    needs: [build_windows, build_macos]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code (for release notes)
        uses: actions/checkout@v4

      - name: Cache compression tools
        uses: actions/cache@v3
        with:
          path: /usr/bin
          key: ${{ env.CACHE_VERSION }}-${{ runner.os }}-compression-tools
          restore-keys: |
            ${{ env.CACHE_VERSION }}-${{ runner.os }}-compression-



      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: shared-clipboard-client-windows-build
          path: windows-build/

      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: shared-clipboard-client-macos-build
          path: macos-build/



      - name: Create Windows zip
        run: |
          cd windows-build
          zip -r ../shared-clipboard-client-windows.zip *

      - name: Create macOS tar.gz
        run: |
          cd macos-build
          tar -czf ../shared-clipboard-client-macos.tar.gz *

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            shared-clipboard-client-windows.zip
            shared-clipboard-client-macos.tar.gz
          generate_release_notes: true
          draft: false
          prerelease: false
          body: |
            ## 共享剪切板客户端 - 发布版本

            这是共享剪切板客户端的自动构建版本，支持以下平台：

            - **Windows**: `shared-clipboard-client-windows.zip`
            - **macOS**: `shared-clipboard-client-macos.tar.gz`

            ### 使用方法
            1. 下载对应平台的压缩包
            2. 解压到任意目录
            3. 根据需要修改配置文件
            4. 运行可执行文件或使用提供的启动脚本

            ### 配置文件
            - `config_example.json`: 配置示例文件
            - `network_config.json`: 网络配置文件

            更多详细信息请参考 README.md 和使用说明.md 文件。

            ---

            **构建信息**:
            - 工作流运行: #${{ github.run_number }}
            - 提交哈希: ${{ github.sha }}

  # 手动构建总结（仅在手动触发时显示）
  manual_build_summary:
    if: ${{ github.event_name == 'workflow_dispatch' }}
    needs: [build_windows, build_macos]
    runs-on: ubuntu-latest
    steps:
      - name: Manual Build Summary
        run: |
          echo "## 手动构建完成" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 构建状态" >> $GITHUB_STEP_SUMMARY



          if [[ "${{ needs.build_windows.result }}" == "success" ]]; then
            echo "- ✅ Windows 构建: 成功" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.build_windows.result }}" == "skipped" ]]; then
            echo "- ⏭️ Windows 构建: 跳过" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ❌ Windows 构建: 失败" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.build_macos.result }}" == "success" ]]; then
            echo "- ✅ macOS 构建: 成功" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.build_macos.result }}" == "skipped" ]]; then
            echo "- ⏭️ macOS 构建: 跳过" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ❌ macOS 构建: 失败" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 构建产物" >> $GITHUB_STEP_SUMMARY
          echo "构建产物已保存为 GitHub Actions Artifacts，可在工作流运行页面下载。" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 说明" >> $GITHUB_STEP_SUMMARY
          echo "- 手动构建不会自动创建 GitHub Release" >> $GITHUB_STEP_SUMMARY
          echo "- 如需创建正式发布，请推送版本标签（如 v1.0.0）" >> $GITHUB_STEP_SUMMARY
          echo "- 构建产物将在 90 天后自动删除" >> $GITHUB_STEP_SUMMARY

  # 构建总结
  build_summary:
    if: always()
    needs: [build_windows, build_macos, create_release]
    runs-on: ubuntu-latest
    steps:
      - name: Build Summary
        run: |
          echo "## 构建总结" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 构建状态" >> $GITHUB_STEP_SUMMARY



          if [[ "${{ needs.build_windows.result }}" == "success" ]]; then
            echo "- ✅ Windows 构建: 成功" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.build_windows.result }}" == "skipped" ]]; then
            echo "- ⏭️ Windows 构建: 跳过" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ❌ Windows 构建: 失败" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.build_macos.result }}" == "success" ]]; then
            echo "- ✅ macOS 构建: 成功" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.build_macos.result }}" == "skipped" ]]; then
            echo "- ⏭️ macOS 构建: 跳过" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ❌ macOS 构建: 失败" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.create_release.result }}" == "success" ]]; then
            echo "- ✅ 发布创建: 成功" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.create_release.result }}" == "skipped" ]]; then
            echo "- ⏭️ 发布创建: 跳过" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ❌ 发布创建: 失败" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 触发信息" >> $GITHUB_STEP_SUMMARY
          echo "- 触发方式: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- 工作流运行: #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- 提交哈希: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
